[supervisord]
nodaemon=true
user=root
logfile=/data/logs/mail/supervisord.log
pidfile=/tmp/supervisord.pid
childlogdir=/data/logs/mail
loglevel=debug

[unix_http_server]
file=/tmp/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# Postfix mail server
[program:postfix]
command=/usr/lib/postfix/sbin/master -d
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/data/logs/mail/postfix.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/data/logs/mail/postfix-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
user=root
priority=100

# OpenDKIM mail signing daemon
[program:opendkim]
command=/usr/sbin/opendkim -f
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/data/logs/mail/opendkim.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/data/logs/mail/opendkim-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
user=opendkim
priority=150

# Dovecot IMAP/POP3 server
[program:dovecot]
command=/usr/sbin/dovecot -F
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/data/logs/mail/dovecot.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/data/logs/mail/dovecot-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
user=root
priority=200

# Certificate hot-reload monitor
[program:cert-monitor]
command=/data/.venv/bin/python /data/src/cert_manager.py --hot-reload --service-type mail --domain %(ENV_MAIL_DOMAIN)s /data/certificates/
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/data/logs/mail/cert-reload.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/data/logs/mail/cert-reload-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
user=root
priority=300
environment=PATH="/data/.venv/bin:%(ENV_PATH)s"

# User configuration hot-reload monitor
[program:user-manager]
command=/data/.venv/bin/python /data/src/user_manager.py --hot-reload --service-type mail --watch /data/user-data/config/users.yaml
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/data/logs/mail/user-reload.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/data/logs/mail/user-reload-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
user=root
priority=400
environment=PATH="/data/.venv/bin:%(ENV_PATH)s"
# Enhanced logging for debugging
startsecs=3
startretries=3
exitcodes=0

# Service health monitor
[program:health-monitor]
command=/usr/local/bin/mail-health-monitor.sh
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/data/logs/mail/health-monitor.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/data/logs/mail/health-monitor-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
user=root
priority=500

# Real-time queue monitor for spam detection
[program:queue-monitor]
command=/usr/local/bin/mail-queue-monitor.sh
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/data/logs/mail/queue-monitor.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/data/logs/mail/queue-monitor-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
user=root
priority=600